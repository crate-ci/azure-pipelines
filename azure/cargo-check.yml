parameters:
  rust: stable
  benches: false
  setup: []
  all_features: false

jobs:
- job: ${{ parameters.name }}
  ${{ if eq(parameters.rust, 'stable') }}:
    displayName: cargo check
  ${{ if ne(parameters.rust, 'stable') }}:
    displayName: cargo +${{ parameters.rust }} check
  pool:
    vmImage: ubuntu-16.04
  steps:
  - template: _setup.yml
    parameters:
      rust: ${{ parameters.rust }}
      setup: ${{ parameters.setup }}
  - bash: |
      if git cat-file -e HEAD:Cargo.lock; then
        echo 'Found Cargo.lock';
        echo '##vso[task.setvariable variable=is_locked]true';
      else
        echo 'Did not find Cargo.lock';
        echo '##vso[task.setvariable variable=is_locked]false';
      fi
    displayName: Are dependencies locked?
  - bash: |
      if grep '[workspace]' Cargo.toml; then
        echo '##vso[task.setvariable variable=is_workspace]true';
      else
        echo '##vso[task.setvariable variable=is_workspace]false';
      fi
    displayName: Is repository a workspace?
  - script: cargo check --locked
    condition: and(succeeded(), eq(variables.is_locked, 'true'))
    displayName: Check that Cargo.lock is satisfiable
  - script: cargo check --all --bins --examples --tests
    displayName: Check compilation w/ default features
  - script: cargo check --all --bins --examples --tests --no-default-features
    displayName: Check compilation w/ no features
    # https://github.com/rust-lang/cargo/issues/7727
    condition: and(succeeded(), eq(variables.is_workspace, 'false'))
  - ${{ if eq('true', parameters.all_features) }}:
    - script: cargo check --all --bins --examples --tests --all-features
      displayName: Check compilation w/ all features

  - ${{ if ne('false', parameters.benches) }}:
    - script: cargo check --benches --all
      displayName: Check benchmarks
